<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Etherio Pay</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.x.x/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/vue@2.x.x/dist/vue.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@8.x.x/firebase-app.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@8.x.x/firebase-auth.min.js" defer></script>
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      align-items: center;
      padding-top:2px0px;
      padding-bottom: 40px;
      background-color: #f5f5f5;
    }

    .form-signin {
      width: 100%;
      max-width: 550px;
      padding: 15px;
      margin: auto;
    }

    .form-signin .checkbox {
      font-weight: 400;
    }

    .form-signin .form-floating:focus-within {
      z-index: 2;
    }

    .form-signin input[type="email"] {
      margin-bottom: -1px;
      border-bottom-right-radius: 0;
      border-bottom-left-radius: 0;
    }

    .form-signin input[type="password"] {
      margin-bottom: 10px;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }

    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }

    .hidden {
      visibility: hidden;
    }
  </style>
</head>

<body>
  <main class="form-signin text-center" v-if="!!account?.identifier">
    <div class="form-floating">
      <input class="form-control" id="floatingInput" style="letter-spacing: 2px;" :value="user.email || user.phoneNumber" readonly>
      <label for="floatingInput">Identifier</label>
    </div>
    <div class="form-floating mt-2 mb-2" hidden>
      <input class="form-control" id="floatingInput" :value="token" readonly>
      <label for="floatingInput">Token</label>
    </div>
    <div class="form-floating mt-2 mb-2" v-if="account">
      <input class="form-control" style="letter-spacing: 2px;" id="floatingInput" :value="price(account.balance)" readonly>
      <label for="floatingInput">Balance (Kyats)</label>
    </div>
    <div v-if="!('balance' in account)">
      <button class="btn btn-block my-2 btn-warning" @click="createAccount">
        Start using Etherio Pay
      </button>
    </div>
    <a class="w-100 btn btn-lg btn-primary my-1" href="transfer.html">Transfer</a>
    <button class="w-100 btn btn-lg btn-primary my-1" @click="signOut">Sign Out</button>
    <div class="table-responsive" v-if="transfered.length">
      <h6>Transfer</h6>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>To</th>
            <th>Amount</th>
            <th>Created At</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="t in transfered" :key="t.ref">
            <td>{{t.recipientId}}</td>
            <td>{{t.amount}}</td>
            <td>{{locale(t.createdAt)}}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="table-responsive" v-if="recieved.length">
      <h6>Recieved</h6>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>From</th>
            <th>Amount</th>
            <th>Created At</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="r in recieved" :key="r.ref">
            <td>{{r.senderId}}</td>
            <td>{{price(r.amount)}}</td>
            <td>{{locale(r.createdAt)}}</td>
          </tr>
        </tbody>
      </table>
    </div>
    </div>
  </main>
  <div id="recaptcha"></div>
  <script>
    window.addEventListener('load', function () {
      firebase.initializeApp({
        apiKey: "AIzaSyBLnixFP-rLWHOOEvxC2pjF1ocCrH2qt1A",
        authDomain: "etherio-pay.firebaseapp.com",
        databaseURL: "https://etherio-pay-default-rtdb.firebaseio.com",
        projectId: "etherio-pay",
        storageBucket: "etherio-pay.appspot.com",
        messagingSenderId: "927983401567",
        appId: "1:927983401567:web:3323be6b7ee9a37a5fb9ea",
        measurementId: "G-SQ08BEE4GJ"
      });

      new Vue({
        data: {
          user: null,
          loggedIn: false,
          token: null,
          account: null,
          transfered: [],
          recieved: [],
        },
        methods: {
          getTransferedLogs() {
            const headers = {
              authorization: `Bearer ${this.token}`
            };
            fetch('/transaction/transfered', { headers })
              .then(res => res.json())
              .then(data => {
                this.transfered = data;
              });
          },
          getRecievedLogs() {
            const headers = {
              authorization: `Bearer ${this.token}`
            };
            fetch('/transaction/recieved', { headers })
              .then(res => res.json())
              .then(data => {
                this.recieved = data;
              });
          },
          getAccount() {
            const headers = {
              authorization: `Bearer ${this.token}`
            };
            fetch('/account', { headers })
              .then(res => res.json())
              .then(data => {
                this.account = data;
              })
          },
          createAccount() {
            const headers = {
              authorization: `Bearer ${this.token}`
            };
            fetch('/account', { method: 'POST', headers })
              .then(() => this.getAccount());
          },
          signOut() {
            firebase.auth().signOut();
          },
          locale(timestamp) {
            return new Date(timestamp).toLocaleString('en-US', {
              timeZone: 'Asia/Yangon'
            });
          },
          price(amount) {
            return parseInt(amount).toLocaleString();
          },
        },
        beforeMount() {
          firebase.auth().onAuthStateChanged((user) => {
            if (user) {
              this.loggedIn = true;
              this.user = user;
              user.getIdToken().then((token) => {
                this.token = token;
                this.getAccount();
                this.getTransferedLogs();
                this.getRecievedLogs();
              })
            } else {
              window.location.href = 'phone-auth.html';
            }
          });
        },
      }).$mount('main');
    });
  </script>
</body>

</html>
